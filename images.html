<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>âš¡ Flash â€“ Memorable Moments</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --text: #f8fafc;
      --muted: #94a3b8;
      --glow1: #818cf8;
      --glow2: #a855f7;
    }

    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      padding: 1rem;
      overflow-x: hidden;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
      animation: fadeInHeader 1s ease-in-out;
    }

    .flash-title {
      font-size: 2.8rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--text);
      text-transform: uppercase;
      text-shadow: 0 0 15px var(--glow1), 0 0 25px var(--glow2);
      animation: glowPulse 2.5s infinite alternate ease-in-out;
    }

    .flash-subtitle {
      font-size: 1rem;
      color: var(--muted);
      margin-top: 0.5rem;
    }

    @keyframes glowPulse {
      0% { text-shadow: 0 0 10px var(--glow1), 0 0 20px var(--glow2); color: #fff; }
      100% { text-shadow: 0 0 25px var(--glow2), 0 0 40px var(--glow1); color: #e0e7ff; }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      padding-bottom: 3rem;
    }

    .img-card {
      background: var(--card);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      transition: transform 0.25s ease, box-shadow 0.3s ease;
      opacity: 0;
      transform: translateY(20px);
    }

    .img-card.visible {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.6s ease, transform 0.4s ease;
    }

    .img-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
    }

    img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      display: block;
    }

    .card-body { padding: 0.8rem 1rem; text-align: left; }
    .img-name { font-size: 1rem; font-weight: 600; color: #e2e8f0; margin: 0.3rem 0; }
    .upload-date { font-size: 0.9rem; color: var(--muted); margin-bottom: 0.5rem; }

    .card-footer {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem;
      border-top: 1px solid #334155;
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
      font-weight: 500;
    }
    button:hover { background: var(--accent-hover); }
    .btn-secondary { background: transparent; border: 1px solid #334155; color: var(--text); }
    .btn-disabled { opacity: 0.45; cursor: not-allowed; }

    .loading { text-align: center; color: var(--muted); margin-top: 2rem; }

    .fullscreen-overlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex; justify-content: center; align-items: center;
      z-index: 1000;
      overflow: auto;
      padding: 10px;
    }
    .fullscreen-overlay img {
      width: auto;
      height: auto;
      max-width: none;
      max-height: none;
      border-radius: 10px;
      box-shadow: 0 0 40px rgba(255,255,255,0.06);
    }

    .exit-btn {
      position: fixed; top: 18px; right: 18px;
      background: #ef4444; color: white; border: none;
      border-radius: 8px; padding: 10px 14px; cursor: pointer;
      z-index: 1001; font-weight: 600;
    }
    .exit-btn:hover { background: #dc2626; }
  </style>
</head>
<body>
  <header>
    <div class="flash-title">âš¡ FLASH</div>
    <div class="flash-subtitle">Capture. Cherish. Relive your moments.</div>
  </header>

  <div id="imgGrid" class="grid"></div>
  <div id="loadingMsg" class="loading">Loading memories...</div>

  <script>
    const repoOwner = "yan-shun-180";
    const repoName = "testing_testing_1";
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/images`;
    const cdnBase = `https://cdn.jsdelivr.net/gh/${repoOwner}/${repoName}/images/`;

    const grid = document.getElementById("imgGrid");
    const loadingMsg = document.getElementById("loadingMsg");
    const userToken = localStorage.getItem("github_token");

    async function fetchJson(url) {
      const headers = userToken ? { Authorization: `token ${userToken}` } : {};
      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchText(url) {
      const headers = url.startsWith("https://api.github.com") && userToken ? { Authorization: `token ${userToken}` } : {};
      const res = await fetch(url, { headers });
      if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
      return res.text();
    }

    async function fetchDataTxt() {
      const raw = `${cdnBase}data.txt?v=${Date.now()}`;
      try {
        return await fetchText(raw);
      } catch {
        console.warn("âš  data.txt not found, continuing without links.");
        return "";
      }
    }

    async function loadImages() {
      if (!userToken) {
        loadingMsg.textContent = "âš  No GitHub token found. Please store one in localStorage as 'github_token'.";
        return;
      }

      try {
        loadingMsg.textContent = "Fetching your flashes...";
        const files = await fetchJson(apiUrl);
        const imageFiles = files.filter(f => /\.(jpe?g|png|gif|webp|avif|svg)$/i.test(f.name));

        const dataTxt = await fetchDataTxt();
        const links = dataTxt ? dataTxt.split(/\r?\n/).map(s => s.trim()).filter(Boolean) : [];

        const withMeta = await Promise.all(imageFiles.map(async f => {
          try {
            const commits = await fetchJson(
              `https://api.github.com/repos/${repoOwner}/${repoName}/commits?path=images/${encodeURIComponent(f.name)}&per_page=1`
            );
            const commit = commits && commits.length ? commits[0] : null;
            const commitDate = commit ? new Date(commit.commit.author.date) : new Date(0);
            return { ...f, commitDate };
          } catch {
            return { ...f, commitDate: new Date(0) };
          }
        }));

        withMeta.sort((a, b) => b.commitDate - a.commitDate);
        grid.innerHTML = "";
        loadingMsg.textContent = "Rendering flashes...";

        withMeta.forEach((file, idx) => {
          const card = document.createElement("div");
          card.className = "img-card";

          const img = document.createElement("img");
          img.alt = file.name;
          img.loading = "lazy";
          img.dataset.src = `${cdnBase}${encodeURIComponent(file.name)}?v=${Date.now()}`;

          const body = document.createElement("div");
          body.className = "card-body";

          const nameLabel = document.createElement("div");
          nameLabel.className = "img-name";
          nameLabel.textContent = file.name.replace(/\.[^/.]+$/, "");

          const dateLabel = document.createElement("div");
          dateLabel.className = "upload-date";
          dateLabel.textContent = file.commitDate.getTime() > 0
            ? `ðŸ“… Captured: ${file.commitDate.toLocaleString()}`
            : "ðŸ“… Captured: Unknown";

          body.append(nameLabel, dateLabel);

          const footer = document.createElement("div");
          footer.className = "card-footer";

          const fullBtn = document.createElement("button");
          fullBtn.textContent = "View Fullscreen";
          fullBtn.onclick = () => openFullscreen(`${cdnBase}${encodeURIComponent(file.name)}?v=${Date.now()}`, file);

          const linkIndex = links.length - 1 - idx;
          const discussionLink = (links && linkIndex >= 0 && linkIndex < links.length) ? links[linkIndex] : null;

          const commentBtn = document.createElement("button");
          commentBtn.textContent = "Comments";
          commentBtn.className = "btn-secondary";
          if (discussionLink) {
            commentBtn.onclick = () => window.open(discussionLink, "_blank", "noopener");
          } else {
            commentBtn.classList.add("btn-disabled");
            commentBtn.disabled = true;
          }

          footer.append(fullBtn, commentBtn);
          card.append(img, body, footer);
          grid.appendChild(card);
          observer.observe(card);
        });

        loadingMsg.textContent = withMeta.length ? "" : "No memories found.";
      } catch (err) {
        console.error(err);
        loadingMsg.textContent = "âš  Could not load flashes. Invalid token or rate limit reached.";
      }
    }

    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target.querySelector("img[data-src]");
          if (img && !img.src) img.src = img.dataset.src;
          entry.target.classList.add("visible");
          obs.unobserve(entry.target);
        }
      });
    }, { rootMargin: "120px 0px" });

    function openFullscreen(url, fileMeta = {}) {
      const overlay = document.createElement("div");
      overlay.className = "fullscreen-overlay";

      const largeImg = document.createElement("img");
      largeImg.src = url;
      largeImg.alt = fileMeta.name || "image";
      overlay.appendChild(largeImg);

      const exitBtn = document.createElement("button");
      exitBtn.className = "exit-btn";
      exitBtn.textContent = "âœ• Exit";
      exitBtn.onclick = () => {
        overlay.remove();
        exitBtn.remove();
      };

      document.body.append(overlay, exitBtn);
    }

    loadImages();
  </script>
</body>
</html>
